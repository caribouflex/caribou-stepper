<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="custom-icons.html">
<link rel="import" href="caribou-step-action-buttons.html">
<link rel="import" href="caribou-stepper-step-property-mixin.html">

<!--
`<caribou-step>` is an element that need to be surrounded by a `<caribou-stepper>` element.

This element correspond correspond to one step of the all stepper.
It can be Editable and Optional. 
These both values corresponds to property that can be set on this element.
Also you can choose the name of each buttons step.
If the stepper is set as Linear, the Skip button will do nothing except if the property Optional is set.

You can add whatever you want inside the `<caribou-step>` element tag.

Each steps will be numbered following the order added into the stepper.

Example:
'<caribou-step label="Information" skip-button optional>
<paper-input always-float-label label="Surname"></paper-input>
<paper-input label="username">
    <iron-icon icon="mail" slot="prefix"></iron-icon>
    <div slot="suffix">@email.com</div>
</paper-input>
</caribou-step>'

### Styling The following custom properties and mixins are available for styling: 

**For the '--step-badge-width' and the '--step-badge-height', there is a border (6px) added to the badge that could not be changed.

Custom property | Description | Default
----------------|-------------|----------
    `--step-connector-line-color` | Color of the line that connect the steps | `#BDBDBD` 
    `--step-saved-label-color` | Color of the label once it's saved | `#424242`
    `--step-active-label-color`| Color of the label when the step is active | `#424242`
    `--step-label-color`| Initial color of the label | `#E0E0E0`
    `--step-badge-height`| The height of the badge (without border) | `18px`
    `--step-badge-width`| The width of the badge (without border) | `18px`
    `--step-save-badge-color`| Color of the badge once the step is saved | `--primary-color`
    `--step-badge-color`| Initial color of the badge | `#9E9E9E`
    `--step-badge-content-color`| Color of the number and the icon inside the badge | `#FFFFFF`
-->
<dom-module id="caribou-step">
    <template>
        <style>
             :host {
                /* display: block; */
            }
            /* General */

            div.layout {
                border-left: 1px solid var(--step-connector-line-color, #BDBDBD);
                margin-left: 24px;
                padding: 10px 28px;
            }
            /* paper-button {
                display: flex;
                justify-content: flex-start;
            } */

            paper-button {
                text-align: center;
                display: flex;
                position: relative;
                justify-content: flex-start;
            }

             :host([horizontal]) paper-button:after {
                content: '';
                border-top: 1px solid var(--step-connector-line-color, #BDBDBD);
                width: 100%;
            }

             :host([optional]) span#subtitle {
                display: block;
                font-size: 0.8em;
                margin-top: 2px;
                max-width: 150px;
                text-transform: capitalize;
            }

             :host span#subtitle {
                display: none;
            }
            /* label button */

             :host([save]) div#labelBtn {
                color: var(--step-saved-label-color, #424242);
                font-weight: inherit;
            }

             :host([save][active]) div#labelBtn,
             :host([active]) div#labelBtn {
                color: var(--step-active-label-color, #424242);
                font-weight: 600;
            }

            div#labelBtn {
                align-self: center;
                padding: 0 16px;
                font-size: 14sp;
                color: var(--step-label-color, #E0E0E0);
            }
            /* icon button */

             :host iron-icon#iconBtn {
                display: none;
                --iron-icon-fill-color: var(--step-badge-content-color, #FFFFFF);
                --iron-icon-stroke-color: var(--step-badge-content-color, #FFFFFF);
            }

             :host([save]) iron-icon#iconBtn {
                display: block;
                border-color: var(--step-save-badge-color, var(--primary-color));
                background-color: var(--step-save-badge-color, var(--primary-color));
            }
            /* Badge */

             :host([save]) span.badgeNumber {
                display: none;
            }

            span.badgeNumber {
                @apply --layout-horizontal;
                @apply --layout-center-justified;
                @apply --layout-center;
                width: var(--step-badge-width, 18px);
                height: var(--step-badge-height, 18px);
            }
            /* Badge and iron-icon */

            iron-icon#iconBtn,
            span.badgeNumber {
                --iron-icon-height: 18px;
                --iron-icon-width: 18px;
                min-width: 18px;
                border-radius: 25px;
                border: 6px solid var(--step-badge-color, #9E9E9E);
                background-color: var(--step-badge-color, #9E9E9E);
                color: var(--step-badge-content-color, #FFFFFF);
            }
        </style>

        <paper-button on-tap="_toggle">
            <iron-icon id="iconBtn" icon="custom-icons:[[_getIcon(editable)]]"></iron-icon>
            <span class="badgeNumber">{{_badgeNumber}}</span>
            <div id="labelBtn">{{label}}
                <span id="subtitle">Optional</span>
            </div>
        </paper-button>
        <div class="layout">
            <iron-collapse id="stepContent" opened="{{active}}">
                <slot></slot>
                <caribou-step-action-buttons id="stepButtons" continue-label="[[continueLabel]]" finish-label="[[finishLabel]]" update-label="[[updateLabel]]"
                    skip-label="[[skipLabel]]" skip-button="[[skipButton]]" back-label="[[backLabel]]" back-button="[[backButton]]"></caribou-step-action-buttons>
            </iron-collapse>
        </div>
    </template>

    <script>
        window.Caribouflex = window.Caribouflex || {};
        Caribouflex.Stepper = Caribouflex.Stepper || {};
        Caribouflex.Stepper.Context = Caribouflex.Stepper.Context || {};

        /**
         * `caribou-step`
         * one step
         *
         * @customElement
         * @polymer
         * @memberof Caribouflex
         * @mixes Caribouflex.Stepper.StepPropertyMixin
         * @demo demo/index.html
         */
        class CaribouStepElement extends Caribouflex.Stepper.StepPropertyMixin(Polymer.Element) {

            /**
             * Fired when the last step has been finished.
             * This event is declared in the 'StepPropertyMixin'.
             * Bubble event.
             *
             * @event last-step-closed
             * @param {Object} detail empty
             */

            static get is() {
                return 'caribou-step';
            }

            static get properties() {
                return {

                    /**
                     * This is the label of the step
                     */
                    label: {
                        type: String
                    },

                    /**
                     * This is the number of the step.
                     * This property is used on the badge.
                     */
                    _badgeNumber: {
                        type: Number,
                        readOnly: true
                    }
                };
            }

            /**
             * Into this constructor we will initialize the badge value.
             * The badge value is determine according a property set and increment into the Caribouflex.Stepper.Context
             */
            constructor() {
                super();
                //init the badge value
                Caribouflex.Stepper.Context.numberOfStep = Caribouflex.Stepper.Context.numberOfStep ===
                    undefined ? 1 : Caribouflex.Stepper.Context.numberOfStep + 1;

                this._set_badgeNumber(Caribouflex.Stepper.Context.numberOfStep);

                //if there is no step behind, we clear the number of step context temp we used.
                if (this.nextElementSibling === null)
                    Caribouflex.Stepper.Context.numberOfStep = undefined;

            }

            /**
             * In this ready function, we will take care of oppening the step if it's the first one 
             * And if the parameter is set for.
             * Then we will call the register function, which is used to register a step into the stepper.
             */
            ready() {
                super.ready();
                var openFirst = this._getOpenFirstStepOnStartup();

                //we open the first step according the value set on the stepper element.
                if (this._badgeNumber === 1)
                    this.active = openFirst;
                else if (this._badgeNumber === 2 && openFirst)
                    this.parentElement.setNextStep(this);

                //register the element
                this._register();
            }

            /**
             * This is a callback function called whent the step title is clicked.
             * This will close all the open steps before opening the one selected, if the criteria are respected.
             * Moreover, if we are in a case of a modification, we will display the update button.
             * @private
             */
            _toggle() {
                if (!this.parentElement.finish && (!this.parentElement.linear && (!this.save || this.editable)) ||
                    (this.parentElement.linear &&
                        this.editable)) {
                    this.parentElement.closeAllStep();
                    this.toggleStep();
                    if (this.save && this.editable)
                        this.$.stepButtons.setUpdate(true);
                }
            }

            /**
             * This function is used to toggle the step. That means, it will open the current step.
             * When a step is open the 'active' property is true.
             * @param {Boolean} isLast This property is used to indicate if this step is the last step of the stepper.
             *                         If it is, we will call the function setFinish() to set the good button.
             */
            toggleStep(isLast) {
                if (isLast !== undefined && isLast)
                    this.$.stepButtons.setFinish(true);

                this.$.stepContent.toggle();
            }

            /**
             * This function is used to set the finish action button state to true.
             * For this step the button will display the finish button. 
             */
            setFinishActionButtonsState() {
                this.$.stepButtons.setFinish(true);
            }

            /**
             * This function is used to get the good icon to display into the badge,
             * accordign to the 'editable' property.
             * @param {Boolean} editable true if it's an editable step, false otherwise.
             * @private
             */
            _getIcon(editable) {
                if (editable)
                    return "create";
                else
                    return "check";
            }

            /**
             * This function is used to reinitialize all the parameter of this element 
             * and the action buttons
             */
            reset(openFirstStep) {
                this.removeAttribute("save");
                this.active = false;
                this.$.stepButtons.reset();
                this.updateStyles();

                if (openFirstStep) {
                    if (this._badgeNumber === 1)
                        this.active = true;
                    else if (this._badgeNumber === 2)
                        this.parentElement.setNextStep(this);
                }
            }
            
        }

        window.customElements.define(CaribouStepElement.is, CaribouStepElement);

        /**
         * @namespace Caribouflex
         */
        window.Caribouflex = window.Caribouflex || {};
        Caribouflex.CaribouStepElement = CaribouStepElement;
    </script>
</dom-module>